// Tractus - Sistema de Gestão New Tractor
// Schema do Banco de Dados - Módulo Comercial

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS
// ==========================================

enum Role {
  ADMIN
  DIRETOR
  COMERCIAL
  TECNICO
  ORCAMENTO
  FINANCEIRO
  PCP
  PRODUCAO
  QUALIDADE
  ALMOXARIFADO
  RH
}

enum DiaSemana {
  SEGUNDA
  TERCA
  QUARTA
  QUINTA
  SEXTA
  SABADO
}

enum StatusLaudo {
  EM_ELABORACAO
  FINALIZADO
  CONVERTIDO_PROPOSTA
}

enum StatusProposta {
  EM_ABERTO
  AGUARDANDO_APROVACAO
  APROVADA
  EM_EXECUCAO
  FATURADA
  CANCELADA
}

enum StatusLiberacaoCusto {
  EM_ANALISE
  APROVADO
  REPROVADO
  AGUARDANDO_AJUSTE
}

enum StatusDespesa {
  PENDENTE
  APROVADA
  REPROVADA
}


enum CondicaoSolo {
  BAIXO_IMPACTO
  MEDIO_IMPACTO
  ALTO_IMPACTO
}

enum StatusDesgaste {
  DENTRO_PARAMETROS
  FORA_PARAMETROS
}

enum CategoriaVenda {
  RODANTE
  PECA
  CILINDRO
}

enum StatusOS {
  ABERTA
  EM_PRODUCAO
  AGUARDANDO_PECAS
  FINALIZADA
  FATURADA
  CANCELADA
}

enum StatusVisitaTecnica {
  PENDENTE
  CONFIRMADA
  REALIZADA
  CANCELADA
}

enum TipoDespesaVeiculo {
  COMBUSTIVEL
  TROCA_OLEO
  REVISAO
  PNEUS_NIVEL
  PNEUS_TROCA
}

enum StatusDespesaVeiculo {
  PENDENTE
  APROVADA
  REPROVADA
}

enum StatusLaudoInspecao {
  RASCUNHO
  ENVIADO
}

enum CondicaoComponente {
  BOM
  REGULAR
  CRITICO
}

// ==========================================
// USUÁRIOS E AUTENTICAÇÃO
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String
  password      String
  photo         String?
  role          Role      @default(COMERCIAL)
  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  vendedor           Vendedor?
  sessions           Session[]
  despesasAprovadas  Despesa[]  @relation("DespesasAprovadas")
  despesasVeiculoAprovadas DespesaVeiculo[] @relation("DespesasVeiculoAprovadas")
  visitasComoInspetor VisitaTecnica[] @relation("InspetorVisitas")
  laudosInspecao     LaudoInspecao[] @relation("InspetorLaudos")

  @@map("users")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ==========================================
// MÓDULO COMERCIAL - VENDEDORES
// ==========================================

model Vendedor {
  id            String    @id @default(cuid())
  userId        String    @unique
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Dados para reembolso de despesas (PIX)
  chavePix      String?
  tipoChavePix  String?   // CPF, CNPJ, EMAIL, TELEFONE, ALEATORIA

  // Cartela de clientes
  clientes      Cliente[]

  // Rotas semanais
  rotas         Rota[]

  // Visitas realizadas
  visitas       Visita[]

  // Propostas emitidas
  propostas     Proposta[]

  // Laudos de inspeção
  laudos        Laudo[]

  // Metas de vendas
  metas         Meta[]

  // Despesas do veículo
  despesas      Despesa[]

  // Vendas realizadas
  vendas        Venda[]

  // Visitas técnicas solicitadas
  visitasTecnicas VisitaTecnica[]

  // Anotações sobre clientes
  anotacoes     ClienteAnotacao[]

  // Despesas de veículo (com km)
  despesasVeiculo DespesaVeiculo[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("vendedores")
}

// ==========================================
// MÓDULO COMERCIAL - CLIENTES
// ==========================================

model Cliente {
  id            String    @id @default(cuid())
  nome          String
  razaoSocial   String?
  cnpj          String?   @unique
  inscricaoEstadual String?

  // Contato
  telefone      String?
  email         String?
  contatoPrincipal String?

  // Endereço
  endereco      String?
  cidade        String?
  estado        String?
  cep           String?

  // Observações para vendedores (dicas sobre o cliente)
  observacoes   String?

  // Relacionamentos
  vendedorId    String?
  vendedor      Vendedor? @relation(fields: [vendedorId], references: [id])

  equipamentos  Equipamento[]
  visitas       Visita[]
  laudos        Laudo[]
  propostas     Proposta[]
  ordensServico OrdemServico[]
  visitasTecnicas VisitaTecnica[]

  // Rota semanal (dias que deve ser visitado)
  rotaClientes  RotaCliente[]

  // Anotações do vendedor sobre o cliente
  anotacoes     ClienteAnotacao[]

  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("clientes")
}

// ==========================================
// MÓDULO COMERCIAL - ANOTAÇÕES DE CLIENTE
// ==========================================

model ClienteAnotacao {
  id            String    @id @default(cuid())

  clienteId     String
  cliente       Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  vendedorId    String
  vendedor      Vendedor  @relation(fields: [vendedorId], references: [id], onDelete: Cascade)

  texto         String    @db.Text

  createdAt     DateTime  @default(now())

  @@map("cliente_anotacoes")
}

// ==========================================
// MÓDULO COMERCIAL - EQUIPAMENTOS
// ==========================================

model Equipamento {
  id            String    @id @default(cuid())

  // Identificação
  modelo        String    // SANY 750H, Caterpillar D6, etc
  marca         String?
  serie         String    // Número de série
  frota         String?   // Código da frota do cliente

  // Horímetro
  horasOperacao Int?
  horasTranslacao Int?

  // Relacionamentos
  clienteId     String
  cliente       Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  laudos        Laudo[]

  active        Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("equipamentos")
}

// ==========================================
// MÓDULO COMERCIAL - ROTAS SEMANAIS
// ==========================================

model Rota {
  id            String      @id @default(cuid())
  nome          String      // "Rota Suelen", "Rota Afonso"

  vendedorId    String
  vendedor      Vendedor    @relation(fields: [vendedorId], references: [id], onDelete: Cascade)

  rotaClientes  RotaCliente[]

  active        Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("rotas")
}

model RotaCliente {
  id            String      @id @default(cuid())

  rotaId        String
  rota          Rota        @relation(fields: [rotaId], references: [id], onDelete: Cascade)

  clienteId     String
  cliente       Cliente     @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  diaSemana     DiaSemana
  ordem         Int         @default(0) // Ordem de visita no dia

  @@unique([rotaId, clienteId, diaSemana])
  @@map("rota_clientes")
}

// ==========================================
// MÓDULO COMERCIAL - VISITAS
// ==========================================

model Visita {
  id            String    @id @default(cuid())

  vendedorId    String
  vendedor      Vendedor  @relation(fields: [vendedorId], references: [id], onDelete: Cascade)

  clienteId     String
  cliente       Cliente   @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  // Controle de tempo
  data          DateTime  @db.Date
  checkIn       DateTime?
  checkOut      DateTime?

  // Geolocalização
  latitudeIn    Float?
  longitudeIn   Float?
  latitudeOut   Float?
  longitudeOut  Float?

  // Endereços (geocodificação reversa)
  enderecoIn    String?
  enderecoOut   String?

  // Observações comerciais
  observacoes   String?   @db.Text

  // Laudo gerado (se houver inspeção)
  laudo         Laudo?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@map("visitas")
}

// ==========================================
// MÓDULO COMERCIAL - LAUDOS DE INSPEÇÃO
// ==========================================

model Laudo {
  id            String        @id @default(cuid())
  numero        String        @unique // Número sequencial do laudo

  // Relacionamentos
  visitaId      String?       @unique
  visita        Visita?       @relation(fields: [visitaId], references: [id])

  equipamentoId String
  equipamento   Equipamento   @relation(fields: [equipamentoId], references: [id])

  clienteId     String
  cliente       Cliente       @relation(fields: [clienteId], references: [id])

  vendedorId    String
  vendedor      Vendedor      @relation(fields: [vendedorId], references: [id])

  // Dados da inspeção
  data          DateTime      @db.Date
  inspetor      String
  local         String?
  condicaoSolo  CondicaoSolo

  // Medições detalhadas (JSON estruturado)
  medicoes      Json          // Array de medições por componente

  // Fotos
  fotos         LaudoFoto[]

  // Sumário e observações
  sumario       String?       @db.Text

  // Status
  status        StatusLaudo   @default(EM_ELABORACAO)

  // Proposta gerada
  proposta      Proposta?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("laudos")
}

model LaudoFoto {
  id            String    @id @default(cuid())
  laudoId       String
  laudo         Laudo     @relation(fields: [laudoId], references: [id], onDelete: Cascade)

  url           String
  componente    String    // "FROTA", "ROLETE_SUPERIOR_LE", etc
  descricao     String?

  createdAt     DateTime  @default(now())

  @@map("laudo_fotos")
}

// ==========================================
// MÓDULO COMERCIAL - PROPOSTAS/ORÇAMENTOS
// ==========================================

model Proposta {
  id            String          @id @default(cuid())
  numero        String          @unique // Número sequencial da proposta

  // Relacionamentos
  laudoId       String?         @unique
  laudo         Laudo?          @relation(fields: [laudoId], references: [id])

  clienteId     String
  cliente       Cliente         @relation(fields: [clienteId], references: [id])

  vendedorId    String
  vendedor      Vendedor        @relation(fields: [vendedorId], references: [id])

  // Valores
  valor         Decimal         @db.Decimal(12, 2)
  custoEstimado Decimal?        @db.Decimal(12, 2)
  margem        Decimal?        @db.Decimal(5, 2) // Percentual

  // Categorias de venda
  categoria     CategoriaVenda  @default(RODANTE)

  // Datas
  dataEmissao   DateTime        @default(now())
  dataValidade  DateTime?

  // Status
  status        StatusProposta  @default(EM_ABERTO)
  motivoCancelamento String?

  // Itens da proposta
  itens         PropostaItem[]

  // Liberação de custo
  liberacaoCusto LiberacaoCusto?

  // OS gerada
  ordemServico  OrdemServico?

  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@map("propostas")
}

model PropostaItem {
  id            String    @id @default(cuid())
  propostaId    String
  proposta      Proposta  @relation(fields: [propostaId], references: [id], onDelete: Cascade)

  descricao     String
  quantidade    Int       @default(1)
  valorUnitario Decimal   @db.Decimal(12, 2)
  valorTotal    Decimal   @db.Decimal(12, 2)

  @@map("proposta_itens")
}

// ==========================================
// MÓDULO COMERCIAL - LIBERAÇÃO DE CUSTO
// ==========================================

model LiberacaoCusto {
  id            String              @id @default(cuid())

  propostaId    String              @unique
  proposta      Proposta            @relation(fields: [propostaId], references: [id], onDelete: Cascade)

  // Análise financeira
  custoReal     Decimal?            @db.Decimal(12, 2)
  margemReal    Decimal?            @db.Decimal(5, 2)

  // Aprovação
  status        StatusLiberacaoCusto @default(EM_ANALISE)
  aprovadoPor   String?
  dataAprovacao DateTime?
  observacoes   String?             @db.Text

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@map("liberacoes_custo")
}

// ==========================================
// MÓDULO COMERCIAL - ORDEM DE SERVIÇO
// ==========================================

model OrdemServico {
  id            String        @id @default(cuid())
  numero        String        @unique // Número da OS

  // Relacionamentos
  propostaId    String?       @unique
  proposta      Proposta?     @relation(fields: [propostaId], references: [id])

  clienteId     String
  cliente       Cliente       @relation(fields: [clienteId], references: [id])

  // Status
  status        StatusOS      @default(ABERTA)

  // Datas
  dataAbertura  DateTime      @default(now())
  dataPrevisao  DateTime?
  dataFechamento DateTime?

  // Valores
  valorTotal    Decimal       @db.Decimal(12, 2)

  // Vendas vinculadas
  vendas        Venda[]

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("ordens_servico")
}

// ==========================================
// MÓDULO COMERCIAL - VENDAS (METAS)
// ==========================================

model Venda {
  id            String        @id @default(cuid())

  vendedorId    String
  vendedor      Vendedor      @relation(fields: [vendedorId], references: [id])

  ordemServicoId String?
  ordemServico  OrdemServico? @relation(fields: [ordemServicoId], references: [id])

  // Dados da venda
  data          DateTime      @db.Date
  valor         Decimal       @db.Decimal(12, 2)
  categoria     CategoriaVenda

  // Semana do mês (para controle de metas)
  semana        Int           // 1, 2, 3 ou 4

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("vendas")
}

model Meta {
  id            String        @id @default(cuid())

  vendedorId    String
  vendedor      Vendedor      @relation(fields: [vendedorId], references: [id], onDelete: Cascade)

  // Período
  mes           Int           // 1-12
  ano           Int

  // Categoria
  categoria     CategoriaVenda

  // Valores
  valorMeta     Decimal       @db.Decimal(12, 2)

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([vendedorId, mes, ano, categoria])
  @@map("metas")
}

// ==========================================
// MÓDULO COMERCIAL - DESPESAS DO VEÍCULO
// ==========================================

model Despesa {
  id            String      @id @default(cuid())

  vendedorId    String
  vendedor      Vendedor    @relation(fields: [vendedorId], references: [id], onDelete: Cascade)

  // Dados da despesa
  data          DateTime    @db.Date
  tipo          String      // Tipo de despesa (texto livre)
  descricao     String?
  valor         Decimal     @db.Decimal(10, 2)

  // Comprovante (foto do cupom/nota fiscal)
  comprovante   String?     // URL da imagem no IMGBB

  // Validação da IA
  validadoPorIA Boolean     @default(false)
  valorExtraido Decimal?    @db.Decimal(10, 2)  // Valor extraído pela IA
  nomeExtraido  String?     // Nome do estabelecimento extraído pela IA

  // Aprovação
  status           StatusDespesa @default(PENDENTE)
  aprovadoPorId    String?
  aprovadoPor      User?         @relation("DespesasAprovadas", fields: [aprovadoPorId], references: [id])
  dataAprovacao    DateTime?
  motivoReprovacao String?

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@map("despesas")
}

// ==========================================
// MÓDULO COMERCIAL - VISITAS TÉCNICAS
// ==========================================

model VisitaTecnica {
  id            String              @id @default(cuid())

  // Número da visita (formato: DD/MM/AAAA-NNNN)
  numero        String?             @unique

  // Quem solicitou
  vendedorId    String
  vendedor      Vendedor            @relation(fields: [vendedorId], references: [id], onDelete: Cascade)

  // Cliente
  clienteId     String
  cliente       Cliente             @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  // Inspetor designado (definido pelo admin ao agendar)
  inspetorId    String?
  inspetor      User?               @relation("InspetorVisitas", fields: [inspetorId], references: [id])

  // Data da visita (definida pelo admin)
  dataVisita    DateTime?           @db.Date

  // Equipamentos (texto livre, múltiplos)
  equipamentos  String[]

  // Observação da vendedora
  observacao    String?             @db.Text

  // Status
  status        StatusVisitaTecnica @default(PENDENTE)

  // Motivo do cancelamento (se houver)
  motivoCancelamento String?

  // Laudo de inspeção (preenchido pelo inspetor)
  laudoInspecao LaudoInspecao?

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@map("visitas_tecnicas")
}

// ==========================================
// MÓDULO COMERCIAL - LAUDO DE INSPEÇÃO
// ==========================================

model LaudoInspecao {
  id                String              @id @default(cuid())

  // Vinculado à visita técnica
  visitaTecnicaId   String              @unique
  visitaTecnica     VisitaTecnica       @relation(fields: [visitaTecnicaId], references: [id], onDelete: Cascade)

  // Inspetor que preencheu o laudo
  inspetorId        String
  inspetor          User                @relation("InspetorLaudos", fields: [inspetorId], references: [id])

  // Dados do equipamento inspecionado
  equipamento       String              // Nome/modelo do equipamento
  numeroSerie       String              // Nº de série

  // Data da inspeção
  dataInspecao      DateTime            @db.Date

  // Componentes avaliados
  componentes       ComponenteInspecao[]

  // Fotos gerais (até 5)
  fotos             String[]            // URLs das fotos no IMGBB

  // Status do laudo
  status            StatusLaudoInspecao @default(RASCUNHO)

  // Data de envio (quando status = ENVIADO)
  dataEnvio         DateTime?

  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@map("laudos_inspecao")
}

model ComponenteInspecao {
  id                String              @id @default(cuid())

  laudoInspecaoId   String
  laudoInspecao     LaudoInspecao       @relation(fields: [laudoInspecaoId], references: [id], onDelete: Cascade)

  // Nome do componente (digitado livremente)
  nome              String

  // Condição avaliada
  condicao          CondicaoComponente

  // Observação técnica (corrigida por IA)
  observacao        String?             @db.Text

  // Ordem de exibição
  ordem             Int                 @default(0)

  createdAt         DateTime            @default(now())

  @@map("componentes_inspecao")
}

// ==========================================
// MÓDULO COMERCIAL - DESPESAS DE VEÍCULO (KM)
// ==========================================

model DespesaVeiculo {
  id               String                @id @default(cuid())

  vendedorId       String
  vendedor         Vendedor              @relation(fields: [vendedorId], references: [id], onDelete: Cascade)

  // Dados da despesa
  data             DateTime              @db.Date
  tipo             TipoDespesaVeiculo
  valor            Decimal               @db.Decimal(10, 2)
  km               Int                   // Quilometragem do odômetro

  // Comprovante (foto do cupom/nota fiscal)
  comprovante      String?               // URL da imagem no IMGBB

  // Validação da IA
  validadoPorIA    Boolean               @default(false)
  valorExtraido    Decimal?              @db.Decimal(10, 2)
  nomeExtraido     String?

  // Aprovação
  status           StatusDespesaVeiculo  @default(PENDENTE)
  aprovadoPorId    String?
  aprovadoPor      User?                 @relation("DespesasVeiculoAprovadas", fields: [aprovadoPorId], references: [id])
  dataAprovacao    DateTime?
  motivoReprovacao String?

  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  @@index([vendedorId, data])
  @@map("despesas_veiculo")
}

model ConfiguracaoManutencao {
  id          String              @id @default(cuid())
  tipo        TipoDespesaVeiculo  @unique
  intervaloKm Int                 // Intervalo em km para alerta
  descricao   String?             // Ex: "Troca de óleo a cada 5.000 km"

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@map("configuracoes_manutencao")
}
